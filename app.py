import os
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import openai
import re

app = Flask(__name__)

line_bot_api = LineBotApi(os.getenv('CHANNEL_ACCESS_TOKEN'))
handler = WebhookHandler(os.getenv('CHANNEL_SECRET'))
openai.api_key = os.getenv('OPENAI_API_KEY')

cards_summary = {
    "A00": "神聖啟程：代表新的開始與純淨能量，妳正踏上新的旅程。",
    "A01": "魔法顯化：妳的願望與意圖正快速顯化，專注妳的目標。",
    "A02": "靈性覺醒：代表直覺提升與覺察增強，妳的內在正在快速覺醒。",
    "A03": "豐盛女神：象徵富足、流動、自我價值，妳值得豐盛的祝福。",
    "A04": "王者權威：代表領導與穩定，現在由妳掌控局勢。",
    "A05": "神聖智慧：表示妳的內在智慧覺醒，更深的理解正在到來。",
    "A06": "靈魂契約：妳正理解生命中的重要關係，並準備接受與轉化。",
    "A07": "勝利前行：象徵勇氣與意志，妳早已知道該往哪個方向前進。",
    "A08": "內在力量：代表自信與整合，真正的力量源自溫柔而堅定的內心。",
    "A09": "深度探索：妳正進入更深層的自我覺察，真相正浮現中。",
    "A10": "命運轉輪：代表改變與命運流轉，準備好迎接新的階段。",
    "A11": "因果平衡：提醒妳對自己的選擇保持誠實，生命正在找回平衡。",
    "A12": "視界重塑：表示轉換視角，困境中蘊藏新的啟發。",
    "A13": "新生蛻變：妳正在經歷重要的蛻變，舊有的故事即將結束。",
    "A14": "靈魂平衡：象徵內在的和諧與療癒，妳的靈魂正找回平衡。",
    "A15": "破除執念：妳正在放下執念，為生命騰出新的空間。",
    "A16": "重生轉化：代表舊有模式的倒塌與重建，擁抱新的自己。",
    "A17": "星辰希望：提醒妳重新相信奇蹟，願望值得再試一次。",
    "A18": "月光洞見：象徵潛意識覺察，深入內心探索妳的真實感受。",
    "A19": "耀眼光明：妳正在勇敢展現真正的自己，接受內在的光芒。",
    "A20": "靈性覺知：表示靈魂層次的召喚，妳正在與高我連結。",
    "A21": "圓滿成就：妳已經走過一段旅程，現在正是好好欣賞成果的時候。",
    "001": "古巴香脂：調和整合，妳最近完成的值得妳好好肯定自己。",
    "002": "綠薄荷：清晰下載，妳最需要的是勇氣踏出一步。",
    "003": "黑胡椒：情緒突破，勇敢表達內心真正的聲音。",
    "004": "綠花白千層：情緒清理，釋放生活中不必要的雜訊。",
    "005": "羅勒：專注與明晰，集中精神完成妳目前重要的任務。",
    "006": "檸檬：願望清晰化，讓妳的目標變得更清晰具體。",
    "007": "冬青：細胞修補，妳的身體需要放下長期累積的負擔。",
    "008": "牛至：深度放下，妳準備好放下某段不再適合妳的情感或關係。",
    "009": "沉香醇百里香：顯化行動啟動，現在就啟動妳想完成的事。",
    "010": "聖羅勒：控制放下與調頻，允許自己放鬆並信任生命。",
    "011": "夏香草：起步與希望，輕輕踏出第一步，不用太過完美。",
    "012": "羅馬洋甘菊：溫柔放鬆，允許自己適時休息與恢復。",
    "013": "胡椒薄荷：清明與創意閃現，快速完成妳想做的事。",
    "014": "葡萄柚：人際魅力與表達自信，勇敢展現妳的活力。",
    "015": "茶樹：情緒清毒與斷捨離，讓生活與情緒重新潔淨。",
    "016": "薑黃：土能量整合，建立妳的日常規律與穩定性。",
    "017": "肉豆蔻：感官覺醒與自我展現，重新連結妳的感官與創造力。",
    "018": "沒藥：情緒封印解鎖，釋放壓抑已久的悲傷與情緒。",
    "019": "甜馬鬱蘭：溫柔陪伴，給予自己溫暖的安慰與陪伴。",
    "020": "鼠尾草：靈性清理與高我連結，清理舊有信念重新出發。",
    "021": "歐芹葉：清除雜質，釋放身心中累積的負擔。",
    "022": "玫瑰草：和諧釋放，放下控制與壓力，讓生活自然流動。",
    "023": "藍艾菊：舊痛釋放，讓妳的心從舊日傷痛中重獲自由。",
    "024": "歐洲赤松：氣場穩固，保護自己的能量與界限。",
    "025": "丁香花苞：情緒釋放與喉輪啟動，表達內心真正的聲音。",
    "026": "雅麗菊：身體放鬆，釋放累積在神經裡的壓力與焦慮。",
    "027": "岩蘭草：地氣連結，扎根當下找到真正的穩定與安心。",
    "028": "檸檬草：行動啟動，現在是妳果斷行動的最佳時刻。",
    "029": "廣藿香：豐盛落實，接納並實踐真正屬於妳的豐盛。",
    "030": "甜茴香：情緒調理，做回妳自己，停止過度迎合他人。",
    "031": "茉莉：愛的共振，允許自己被愛與親密靠近。",
    "032": "冷杉：氣場穩固，別忘記你也值得依靠與支撐。",
    "033": "黑雲杉：餘壓釋放，妳的內在壓力已到釋放的時候。",
    "034": "香草：輕盈與表達，讓生活中小小的幸福更加明顯。",
    "035": "印度檀香木：高維訊息接收，接納來自宇宙的指引。",
    "036": "西洋蓍草：突破限制，妳早就知道該如何前進了。",
    "037": "苦橙葉：情緒安撫，誠實面對內心的脆弱與感受。",
    "038": "馬鞭草：行動注入，點燃熱情，馬上啟動你的目標。",
    "039": "天竺葵：愛與柔軟，內心正在尋求溫柔與安慰。",
    "040": "芹菜籽：平衡身心，提醒妳不要勉強自己。",
    "041": "杜松漿果：情緒釐清，解開內在情緒的結。",
    "042": "香蜂草：安撫舒眠，允許自己徹底放鬆休息。",
    "043": "藍膠尤加利：清場清理，釋放雜亂，重整內在平靜。",
    "044": "迷迭香：專注提升，妳的目標值得妳的專注。",
    "045": "芳璋：情緒鬆綁，放下壓抑，找回自由。",
    "046": "阿米香樹：安全感灌注，找回內在穩定與支持。",
    "047": "蘇剛達：動能啟動，妳的行動力是啟動改變的關鍵。",
    "048": "快樂鼠尾草：微笑記憶，找回快樂，妳值得笑容。",
    "049": "山雞椒：行動力提振，鼓起勇氣去完成它。",
    "050": "佛手柑：人際流動，保持溫柔的溝通與互動。",
    "051": "辣椒：衝動整合，安全地釋放內在能量。",
    "052": "麥盧卡：內在傷修復，療癒舊有傷痛，釋放情緒。",
    "053": "乳香：靈性呼吸，放下困惑，傾聽內在智慧。",
    "054": "真正薰衣草：安撫神經，給自己溫暖的療癒時光。",
    "055": "玫瑰：愛與接納，允許愛流入妳的生命。",
    "056": "永久花：深層釋放，面對內心深處的感受與情緒。",
    "057": "甜橙：快樂能量，感受簡單的快樂與喜悅。",
    "058": "胡荽：放下雜念，給心靈多一點空間與安靜。",
    "059": "依蘭依蘭：感官開放，重新連結內在的陰性能量。",
    "060": "絲柏：氣場紮根，重新找到妳的內在穩定。",
    "061": "雪松：安定沉穩，找到內心的平靜。",
    "062": "花梨木：滋養與連結，溫柔地陪伴自己與他人。",
    "063": "萊姆：活力再現，提振精神與行動力。",
    "064": "檜木：家族穩頻，穩固你的根基能量。",
    "065": "薑：點火啟動，點燃內在力量。",
    "066": "粉紅胡椒：情緒邊界強化，清晰設立情緒界限。",
    "067": "岩玫瑰：恐懼釋放，勇敢面對內在的恐懼。",
    "068": "肉桂：豐盛行動力，啟動財務與成功的能量。",
    "069": "聖木：靈性淨化，淨化內外空間與能量。",
    "070": "桂花樹：美好顯化，呈現內在的美好與優雅。",
    "071": "德國洋甘菊：情緒安撫，照顧內在情緒。",
    "072": "聖約翰草：陰影照見，勇敢面對內心深處。",
    "073": "百里酚百里香：決斷與強化，果斷行動並下決定。",
    "074": "穗甘松：放鬆與修復，深層放鬆內在壓力。",
    "075": "歐白芷根：地氣支持，穩固內在基礎。",
    "076": "當歸：滋養與修復，滋補內在元氣。",
    "077": "川芎：動能啟動，激發內在行動力。",
    "078": "羅文莎葉：行動顯化，積極行動與顯化願望。",
    "079": "癒創木：榮耀開展，展現自信與魅力。",
    "080": "白松香：能量穩場，穩固並守護自己的能量。",
    "081": "銀松：榮耀光耀，展現自己的獨特光芒。",
    "082": "胡荽籽：願景啟動，清晰設定願景與目標。",
    "083": "樺樹：肉體釋放，釋放內在的壓力與疲憊。",
    "084": "藏茴香：細節和緩，慢慢來並細緻地對待自己。",
    "085": "桉油樟：清場出走，放下內在的混亂與雜訊。",
    "086": "荳蔻：提神醒腦，激發靈感與活力。",
    "087": "白千層：淨氣平衡，清理空間與能量場。",
    "088": "薄荷（芳樟葉薄荷）：清新重啟，重新啟動內在動能。",
    "089": "歐白芷籽：溫柔滋養，溫柔對待並照顧內在。",
    "090": "檸檬尤加利：淨氣與平衡，調整內在能量平衡。",
    "091": "椰子油：滋養安穩，允許自己被溫柔滋養與照顧。",
    "092": "玫瑰果：自我修復，再次溫柔地相信自己，重拾自信。",
    "093": "瓊崖海棠：深層創傷調理，勇敢療癒內在的傷口與陰影。",
    "094": "沙棘果籽：細胞活化，重新激發生命活力，恢復能量。",
    "095": "向日葵：陽光灌注，讓自己更勇敢地被看見與肯定。",
    "096": "曙光守護：願景點燃，勇敢踏出新開始的第一步。",
    "097": "靈性錨定：靜心錨定，讓靈魂穩定且安定下來。",
    "098": "深層舒緩：安撫放鬆，允許自己安靜休息，放鬆身心。",
    "099": "極境森語：大地之心，回歸內心穩定，重新找到歸屬感。",
    "100": "舒心樂活：快樂振動，允許自己享受生活的小美好。",
    "101": "沐心安然：安撫與放鬆，釋放內心壓力，安然回歸平靜。",
    "102": "豐盛之源：顯化流動，打開豐盛之門，接受美好來臨。",
    "103": "女神甦醒：愛與價值，內在力量甦醒，展現真實自我。",
    "104": "清逸之息：清明決策，保持心智清晰，冷靜決定下一步。",
    "105": "時光之顏：自我風格展現，欣賞並展現自己的美好。",
    "106": "橙光律動：喜悅行動力，活力行動，帶動正向好心情。",
    "107": "淨界之門：情緒清空，結束不再適合自己的能量空間。",
    "108": "馨悅之境：愉悅擴展，為自己創造美好的情緒與生活空間。",

}

def normalize_text(text):
    return re.sub(r'\W+', '', text).lower()

def search_card_by_name(user_input):
    normalized_input = normalize_text(user_input)
    for card_key, card_summary in cards_summary.items():
        if normalize_text(card_key) == normalized_input or normalized_input in normalize_text(card_summary):
            return card_key, card_summary
    return None, None

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_input = event.message.text.strip()

    # 嘗試直接從使用者輸入中提取牌卡編號或數字
    card_pattern = re.compile(r'(A\d{2,3}|\d{3})', re.IGNORECASE)
    card_match = card_pattern.search(user_input)

    if card_match:
        extracted_key = card_match.group().upper()
        card_key, card_summary = search_card_by_name(extracted_key)
    else:
        card_key, card_summary = search_card_by_name(user_input)

    if card_key:
        prompt = (
            f"這是馥靈之鑰牌卡「{card_key}」的基本訊息：{card_summary}\n"
            "請根據這個訊息，提供使用者溫暖且深入的智慧指引、生活建議，以及適合今天執行的簡易能量調頻儀式。"
        )
       response = openai.ChatCompletion.create(
    model="gpt-3.5-turbo",  # 如果無法使用GPT-4o，暫時改成gpt-3.5-turbo
            messages=[
                {"role": "system", "content": "你是馥靈之鑰的專業情緒共振牌卡解讀師，請提供溫暖、深入且富有洞察的解讀，善用心經的智慧但不提及心經來解讀。"},
                {"role": "user", "content": prompt}
            ],
            max_tokens=400,
            temperature=1.0
        )
        card_reading = response.choices[0].message.content.strip()

        additional_message = (
            "\n\n✨ 如果你還有其他的心裡疑惑，或想知道更多高維給你的訊息，"
            "歡迎進一步抽取三張、五張、七張，甚至十五張牌，"
            "抽完後直接將牌卡名稱貼在視窗，將由逸君老師親自為你提供專業的深入解牌（有償服務）。"
            "\n\n💫 或是你也覺得這個方式可以成為你的副業增加收入，歡迎直接告訴我們，逸君老師會為你提供完整的副業培訓計畫。"
        )

        reply = f"{card_reading}{additional_message}"
    else:
        reply = f"⚠️ 無法找到你輸入的牌卡「{user_input}」喔！\n\n請檢查一下輸入的牌卡編號或名稱是否正確喔！"

    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))
